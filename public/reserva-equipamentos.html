<!DOCTYPE html>
<html lang="pt-BR">
<head>
  <meta charset="UTF-8" />
  <title>Reserva de Equipamentos</title>
  <style>
    body {
      font-family: Arial, sans-serif;
      padding: 30px;
      background-color: #f5f5f5;
    }

    h1 {
      color: #003668;
      margin-bottom: 20px;
    }

    .equipamento {
      background-color: #fff;
      border: 1px solid #ccc;
      padding: 15px;
      margin-bottom: 15px;
      border-radius: 8px;
    }

    .equipamento h3 {
      margin-bottom: 5px;
    }

    form {
      margin-top: 30px;
      background: #fff;
      padding: 20px;
      border-radius: 8px;
      max-width: 400px;
    }

    input, select, button {
      display: block;
      width: 100%;
      margin-top: 10px;
      padding: 10px;
      border-radius: 6px;
      border: 1px solid #ccc;
    }

    button {
      background-color: #003668;
      color: #fff;
      font-weight: bold;
      border: none;
      cursor: pointer;
    }

    #msg {
      margin-top: 20px;
      font-weight: bold;
    }
  </style>
</head>
<body>
  <h1>Reserva de Equipamentos</h1>

  <div id="lista-equipamentos"></div>

  <form id="form-equipamento">
    <h2>Adicionar Novo Equipamento</h2>
    <input type="text" id="nome" placeholder="Nome do equipamento" required />
    <input type="text" id="descricao" placeholder="Descrição" required />
    <input type="number" id="quantidade" placeholder="Quantidade" min="1" required />
    <button type="submit">Salvar Equipamento</button>
    <div id="msg"></div>
  </form>

  <form id="form-reserva" style="margin-top: 40px;">
    <h2>Reservar Equipamento</h2>

    <label for="equipamento">Equipamento:</label>
    <select id="equipamento" required></select>

    <label for="inicio">Data de Início:</label>
    <input type="date" id="inicio" required />

    <label for="fim">Data de Fim:</label>
    <input type="date" id="fim" required />

    <label for="destinatario">Reservar para (usuário):</label>
    <select id="destinatario" required>
      <option value="">Selecione um funcionário</option>
    </select>

    <button type="submit">Fazer Reserva</button>
    <div id="msg-reserva"></div>
  </form>

  <script>
    const usuario = JSON.parse(sessionStorage.getItem('usuario'));

    if (!usuario || usuario.tipoUsuario !== 'supervisor') {
      document.getElementById('form-equipamento').style.display = 'none';
      document.getElementById('form-reserva').style.display = 'none';
      const aviso = document.createElement('p');
      aviso.style.color = 'red';
      aviso.innerText = '⚠️ Apenas supervisores podem cadastrar e reservar equipamentos.';
      document.body.appendChild(aviso);
    }

    async function carregarEquipamentos() {
      try {
        const res = await fetch('/equipamento');
        const equipamentos = await res.json();

        const container = document.getElementById('lista-equipamentos');
        container.innerHTML = '';

        equipamentos.forEach(eq => {
          const div = document.createElement('div');
          div.className = 'equipamento';
          div.innerHTML = `
            <h3>${eq.nome}</h3>
            <p>${eq.descricao}</p>
            <p><strong>Quantidade:</strong> ${eq.quantidade}</p>
          `;
          container.appendChild(div);
        });
      } catch (err) {
        console.error('Erro ao carregar equipamentos:', err);
      }
    }

    async function carregarEquipamentosParaReserva() {
      try {
        const res = await fetch('/equipamento');
        const equipamentos = await res.json();

        const select = document.getElementById('equipamento');
        select.innerHTML = '<option value="">Selecione um equipamento</option>';

        equipamentos.forEach(eq => {
          const option = document.createElement('option');
          option.value = eq.nome;
          option.textContent = eq.nome;
          select.appendChild(option);
        });
      } catch (err) {
        console.error('Erro ao carregar equipamentos:', err);
      }
    }

    async function carregarDestinatariosDoMesmoSetor() {
      try {
        const res = await fetch('/usuarios');
        const usuarios = await res.json();

        const select = document.getElementById('destinatario');
        select.innerHTML = '<option value="">Selecione um funcionário</option>';

        const mesmoSetor = usuarios.filter(u =>
          u.setor === usuario.setor && u.tipoUsuario !== 'supervisor'
        );

        mesmoSetor.forEach(u => {
          const option = document.createElement('option');
          option.value = u.usuario;
          option.textContent = u.usuario;
          select.appendChild(option);
        });
      } catch (err) {
        console.error('Erro ao carregar usuários:', err);
      }
    }

    document.getElementById('form-equipamento').addEventListener('submit', async (e) => {
      e.preventDefault();

      const nome = document.getElementById('nome').value;
      const descricao = document.getElementById('descricao').value;
      const quantidade = parseInt(document.getElementById('quantidade').value);

      try {
        const res = await fetch('/equipamento', {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify({ nome, descricao, quantidade })
        });

        const data = await res.json();
        const msgDiv = document.getElementById('msg');

        if (data.success) {
          msgDiv.style.color = 'green';
          msgDiv.innerText = '✅ Equipamento adicionado com sucesso.';
          carregarEquipamentos();
          e.target.reset();
        } else {
          msgDiv.style.color = 'red';
          msgDiv.innerText = '❌ Erro ao adicionar equipamento.';
        }
      } catch (err) {
        console.error('Erro ao enviar equipamento:', err);
      }
    });

    document.getElementById('form-reserva').addEventListener('submit', async (e) => {
      e.preventDefault();

      const nomeEquipamento = document.getElementById('equipamento').value;
      const inicio = document.getElementById('inicio').value;
      const fim = document.getElementById('fim').value;
      const destinatario = document.getElementById('destinatario').value;

      const reserva = {
        equipamento: nomeEquipamento,
        inicio,
        fim,
        supervisor: usuario.usuario,
        setor: usuario.setor,
        destinatario
      };

      try {
        const res = await fetch('/reserva-equipamento', {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify(reserva)
        });

        const data = await res.json();
        const msgDiv = document.getElementById('msg-reserva');

        if (data.success) {
          msgDiv.style.color = 'green';
          msgDiv.innerText = '✅ Reserva realizada com sucesso.';
          e.target.reset();
        } else {
          msgDiv.style.color = 'red';
          msgDiv.innerText = '❌ ' + (data.message || 'Erro ao fazer reserva.');
        }
      } catch (err) {
        console.error('Erro ao reservar equipamento:', err);
      }
    });

    if (usuario && usuario.tipoUsuario === 'supervisor') {
      carregarEquipamentos();
      carregarEquipamentosParaReserva();
      carregarDestinatariosDoMesmoSetor();
    }
  </script>
</body>
</html>
